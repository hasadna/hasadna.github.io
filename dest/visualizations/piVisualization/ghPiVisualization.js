function get_start_angle(d,ref){if(ref){var ref_span=ref.stop_deg-ref.start_deg;return(d.start_deg-ref.start_deg)/ref_span*Math.PI*2}return d.start_deg}function get_stop_angle(d,ref){if(ref){var ref_span=ref.stop_deg-ref.start_deg;return(d.stop_deg-ref.start_deg)/ref_span*Math.PI*2}return d.start_deg}function get_level(d,ref){return ref?d.level-ref.level:d.level}function humanFileSize(bytes,si){var thresh=si?1e3:1024;if(thresh>bytes)return bytes+" B";if(si)var units=["kB","MB","GB","TB","PB","EB","ZB","YB"];else var units=["KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"];var u=-1;do bytes/=thresh,++u;while(bytes>=thresh);return bytes.toFixed(1)+" "+units[u]}App.directive("ghVisualization",function(pieChartService,commentsHandler){var id_const="pi_id_",viewportWidth=Math.max(document.documentElement.clientWidth,window.innerWidth||0),viewportHeight=Math.max(document.documentElement.clientHeight,window.innerHeight||0),width=viewportWidth/2,height=width,data_slices=new Array,max_level=6,color=d3.scale.category20c();return{restrict:"E",link:function(scope,element){pieChartService.getJSON(scope.eKnight[0],function(data){scope.piChartData=data});var svg=d3.select(element[0]).append("svg").attr("width",width).attr("height",height).attr("class","filesPiChart").attr("id","filesPiChart").append("g").attr("transform","translate("+viewportWidth/1.5+","+.52*viewportHeight+")");scope.$watch("piChartData",function(){function process_data(data,level,start_deg,stop_deg){var name=data.name,total=data.size,size=data.size,children=data.children,current_deg=start_deg;if(!(level>max_level)&&start_deg!==stop_deg){data_slices.push({start_deg:start_deg,stop_deg:stop_deg,name:name,level:level,total:total,size:size,log:data.log});for(var key in children){var child=children[key],inc_deg=(stop_deg-start_deg)/total*child.size,child_start_deg=current_deg;current_deg+=inc_deg;var child_stop_deg=current_deg;process_data(child,level+1,child_start_deg,child_stop_deg)}}}function update_legend(d){legend.text(d.name),legend.transition().duration(200).style("opacity","1"),legend_fileSize.text(humanFileSize(d.total,!0)),legend_fileSize.transition().duration(200).style("opacity","1")}function remove_legend(){legend.transition().duration(1e3).style("opacity","0"),legend_fileSize.transition().duration(1e3).style("opacity","0")}function rebaseTween(new_ref){return function(d){var level=d3.interpolate(get_level(d,ref),get_level(d,new_ref)),start_deg=d3.interpolate(get_start_angle(d,ref),get_start_angle(d,new_ref)),stop_deg=d3.interpolate(get_stop_angle(d,ref),get_stop_angle(d,new_ref));return function(t){return arc([start_deg(t),stop_deg(t),d.name,level(t)])}}}function animate(d){if(!animating){logBox.clean();for(var i=0;i<d.log.length;i++){var comm=document.createElement("p");i%2!==0&&comm.classList.add("pi-odd"),comm.innerHTML='<span class="pi-author">'+d.log[i].author+'</span> commited <span title="'+d.log[i].date+'">'+commentsHandler.timeSince(d.log[i].date)+'</span> ago.<br><span class="pi-comm-title">Message</span>:<br><span class="pi-message">'+d.log[i].body+"</span>",logBox.appendChild(comm)}animating=!0;var new_ref,last_ref,revert=!1;d===ref&&last_refs.length>0&&(revert=!0,last_ref=last_refs.pop()),revert?(d=last_ref,new_ref=ref,svg.selectAll(".form").filter(function(b){return b.start_deg>=last_ref.start_deg&&b.stop_deg<=last_ref.stop_deg&&b.level>=last_ref.level?!0:!1}).transition().duration(1e3).style("opacity","1").attr("pointer-events","all")):(new_ref=d,svg.selectAll(".form").filter(function(b){return b.start_deg<d.start_deg||b.stop_deg>d.stop_deg||b.level<d.level?!0:!1}).transition().duration(1e3).style("opacity","0").attr("pointer-events","none")),svg.selectAll(".form").filter(function(b){return b.start_deg>=new_ref.start_deg&&b.stop_deg<=new_ref.stop_deg&&b.level>=new_ref.level?!0:!1}).transition().duration(1e3).attrTween("d",rebaseTween(d)),setTimeout(function(){animating=!1,revert?ref=d:(last_refs.push(ref),ref=d)},1e3)}}if(void 0!==scope.piChartData){process_data(scope.piChartData,0,0,2*Math.PI);var ref=data_slices[0],last_refs=new Array,thickness=width/2/(max_level+2)*1.1,arc=d3.svg.arc().startAngle(function(d){var level=void 0!==d.level?d.level:d[3],start_deg=void 0!==d.start_deg?d.start_deg:d[0];return 0===level?start_deg:start_deg+.01}).endAngle(function(d){var level=void 0!==d.level?d.level:d[3],stop_deg=void 0!==d.stop_deg?d.stop_deg:d[1];return 0===level?stop_deg:stop_deg-.01}).innerRadius(function(d){var level=void 0!==d.level?d.level:d[3];return 1.1*level*thickness}).outerRadius(function(d){var level=void 0!==d.level?d.level:d[3];return(1.1*level+1)*thickness}),slices=svg.selectAll(".form").data(function(){return data_slices}).enter().append("g");slices.append("path").attr("d",arc).attr("id",function(d,i){return id_const+i}).style("fill",function(d){return color(d.name)}).on("click",animate).on("mouseover",update_legend).on("mouseout",remove_legend).attr("class","form").append("svg:title").text(function(d){return d.name});var legX=10+-viewportWidth/3.3;legX=-viewportWidth+900;var legend=svg.append("text").attr("x",legX).attr("y",.47*-viewportHeight).style("font-size","34px").text(""),legend_fileSize=svg.append("text").attr("x",legX).attr("y",.43*-viewportHeight).style("font-size","20px").text(""),animating=!1,logBox=document.createElement("div");element[0].appendChild(logBox),logBox.id="log-box",logBox.clean=function(){for(;this.firstChild;)this.removeChild(this.firstChild)}}})}}});